# 端口管理说明

## 📋 概述

项目已配置固定的开发服务器端口为 **3000**，并提供了智能的端口冲突处理机制。

## 🔧 配置文件

### 环境变量配置 (`.env.local`)
```bash
# 开发服务器端口配置
PORT=3000
NEXT_PORT=3000
```

### 服务器配置 (`config/server.json`)
```json
{
  "development": {
    "port": 3000,
    "host": "localhost",
    "autoOpenBrowser": true,
    "fallbackPorts": [3001, 3002, 3003, 3004, 3005]
  }
}
```

## 🚀 启动方式

### 1. 标准启动
```bash
pnpm dev
```
固定使用端口 3000

### 2. 智能启动（推荐）
```bash
pnpm run smart-dev
```
自动处理端口冲突，提供交互式选择

### 3. 端口管理命令
```bash
# 检查端口状态
pnpm run port-status

# 检查并处理端口冲突
pnpm run port-check

# 终止指定端口的进程
pnpm run port-kill [端口号]

# 查找可用端口
pnpm run port-find [起始端口]
```

## ⚠️ 端口冲突处理

### 当端口 3000 被占用时会发生什么？

1. **自动检测**: 系统会检测端口是否被占用
2. **进程识别**: 识别占用端口的进程类型
3. **智能处理**: 提供以下选项：
   - 终止现有进程并重新启动
   - 自动查找其他可用端口
   - 手动处理
   - 退出操作

### 处理策略

#### 如果是 Next.js 开发服务器占用
- 提示可能是重复启动
- 询问是否终止现有进程
- 支持一键重启

#### 如果是其他应用占用
- 显示占用进程信息
- 自动查找替代端口
- 提供手动处理建议

## 🛠️ 常用场景

### 场景1: 正常启动
```bash
pnpm run smart-dev
```
输出：
```
🚀 智能启动开发服务器...
📦 检测到包管理器: pnpm
🔍 检查端口 3000...
✅ 端口 3000 可用
🎯 使用 pnpm 在端口 3000 启动开发服务器...
```

### 场景2: 端口被占用
```bash
pnpm run smart-dev
```
输出：
```
🚀 智能启动开发服务器...
📦 检测到包管理器: pnpm
🔍 检查端口 3000...
⚠️  端口 3000 已被占用
🔍 检测到可能是 Next.js 开发服务器正在运行
📋 进程信息: node 12345 user ... next-server
是否要终止现有进程并重新启动？(y/N):
```

### 场景3: 查看端口状态
```bash
pnpm run port-status
```
输出：
```
📊 端口状态报告
配置端口: 3000
状态: 可用
```

## 🔍 故障排除

### 问题1: 脚本没有执行权限
```bash
chmod +x scripts/port-manager.sh
chmod +x scripts/smart-dev.sh
```

### 问题2: 端口仍然被占用
```bash
# 手动查看端口占用
lsof -i :3000

# 强制终止进程
pnpm run port-kill 3000
```

### 问题3: 找不到可用端口
```bash
# 查找从 3001 开始的可用端口
pnpm run port-find 3001
```

## 📝 最佳实践

1. **使用智能启动**: 优先使用 `pnpm run smart-dev` 而不是 `pnpm dev`
2. **定期检查**: 使用 `pnpm run port-status` 检查端口状态
3. **清理进程**: 开发结束后及时终止开发服务器
4. **配置备份**: 保持 `config/server.json` 配置的备份

## 🔄 自动化集成

项目已集成到以下流程：
- **预构建检查**: 构建前自动检查端口状态
- **健康检查**: 定期验证服务器状态
- **清理脚本**: 上线前自动清理相关进程