# 测试工具指南

## 概述

项目提供了多种测试工具来验证不同功能模块的正确性，包括AI模型验证、Markdown解析测试、内容保护功能测试等。

## 测试工具列表

### 1. AI模型验证脚本 (`scripts/verify-models.js`)

验证所有配置的AI模型是否可用。

#### 使用方法
```bash
node scripts/verify-models.js
```

#### 输出示例
```
✅ deepseek-ai/DeepSeek-V3 - 可用
✅ Qwen/Qwen2.5-72B-Instruct - 可用
✅ moonshot-v1-8k - 可用
❌ some-model - 不可用: 404 Model not found
```

#### 功能特性
- 检查所有配置模型的可用性
- 验证API密钥是否正确
- 提供详细的错误信息
- 支持批量模型验证

### 2. PDF转换功能测试脚本 (`scripts/test-pdf-conversion.js`)

验证PDF转换服务的完整功能，包括健康检查、功能测试和性能测试。

#### 使用方法
```bash
node scripts/test-pdf-conversion.js
```

#### 功能特性
- **健康检查**: 验证PDF服务状态和LibreOffice可用性
- **功能测试**: 实际生成PDF文件并验证输出质量
- **性能测试**: 多次测试统计成功率和平均响应时间
- **文件保存**: 自动保存生成的PDF文件到test-output目录
- **详细日志**: 彩色输出和详细的测试进度信息

#### 输出示例
```
🧪 PDF转换功能测试
==================
ℹ️  检查PDF服务健康状态...
✅ PDF服务正常运行
ℹ️  转换器: LibreOffice
ℹ️  命令: libreoffice
ℹ️  版本: LibreOffice 7.4.2.3

ℹ️  测试PDF生成功能...
✅ PDF生成成功
✅ PDF文件已保存: ./test-output/test-1642567890123.pdf
ℹ️  文件大小: 245760 bytes

ℹ️  执行性能测试...
ℹ️  执行第 1/3 次测试...
✅ 测试 1 完成: 3245ms, 245760 bytes
ℹ️  执行第 2/3 次测试...
✅ 测试 2 完成: 2987ms, 246123 bytes
ℹ️  执行第 3/3 次测试...
✅ 测试 3 完成: 3156ms, 245892 bytes

ℹ️  性能测试结果:
ℹ️  成功率: 3/3 (100.0%)
ℹ️  平均响应时间: 3129ms

✅ 所有测试完成!
ℹ️  生成的测试文件位于: ./test-output
ℹ️    - test-1642567890123.pdf
ℹ️    - performance-test-1.pdf
ℹ️    - performance-test-2.pdf
ℹ️    - performance-test-3.pdf
```

### 3. Markdown解析测试脚本 (`temp/test-export.js`)

验证Markdown解析器的功能完整性和准确性。

#### 使用方法
```bash
pnpm test
# 或者直接运行
node tests/scripts/test-markdown-export.js
```

#### 测试内容
脚本包含完整的Markdown格式测试用例：

```markdown
# 测试标题

这是一个**加粗文本**和*斜体文本*的段落。

## 列表测试

- 项目1
- 项目2
- [x] 已完成任务
- [ ] 未完成任务

> 这是一个引用块

```javascript
console.log("Hello World");
```

| 姓名 | 年龄 |
|------|------|
| 张三 | 25   |
| 李四 | 30   |

---

结束。
```

#### 验证的格式类型
- **标题**: H1、H2等各级标题
- **格式化文本**: 加粗(**text**)、斜体(*text*)
- **列表**: 普通列表(-)、数字列表(1.)、任务列表([x])
- **引用块**: 单级和多级引用(>)
- **代码块**: 带语言标识的代码块(```)
- **表格**: 标准Markdown表格格式
- **分隔线**: 水平分隔线(---)

#### 输出示例
```
测试Markdown内容:
# 测试标题

这是一个**加粗文本**和*斜体文本*的段落。
...

解析结果应该包含:
- 标题 (H1, H2)
- 格式化文本 (加粗, 斜体)
- 列表 (普通列表, 任务列表)
- 引用块
- 代码块
- 表格
- 分隔线
```

#### 功能特性
- **全面覆盖**: 测试所有支持的Markdown格式
- **开发友好**: 提供清晰的测试输出和说明
- **易于扩展**: 可以轻松添加新的测试用例
- **调试支持**: 便于开发者验证解析器功能

### 4. 核心功能完整性测试脚本 (`scripts/test-core-functionality.js`)

验证UI简化后所有核心功能的完整性，特别关注流式响应功能。

#### 使用方法
```bash
node scripts/test-core-functionality.js
```

#### 测试覆盖范围
- **健康检查**: 验证服务器基本运行状态
- **方案生成API (流式响应)**: 测试AI方案生成的流式响应功能
- **关键词拓展API**: 验证智能关键词拓展功能
- **PDF导出功能**: 测试PDF文档生成和导出
- **Word导出功能**: 测试Word文档生成和导出
- **缓存状态API**: 验证系统缓存状态和统计

#### 流式响应测试特性
- **内容类型验证**: 检查`text/event-stream`响应格式
- **数据格式检查**: 验证`data:`前缀的流式数据格式
- **数据块统计**: 计算接收到的数据块数量
- **响应完整性**: 确保流式响应正常接收和处理

#### 输出示例
```
🚀 开始核心功能测试
==================================================

🔍 测试1: 健康检查
✅ 服务器正常运行

🔍 测试2: 方案生成API (流式响应)
✅ 方案生成API正常 (流式响应)
✅ 返回流式响应格式正确
✅ 流式数据格式正确
✅ 接收到 15 个数据块

🔍 测试3: 关键词拓展API
✅ 关键词拓展API正常
✅ 店铺品类关键词: 5 个
✅ 店铺特色关键词: 8 个

🔍 测试4: PDF导出功能
✅ PDF生成API正常
✅ 返回PDF格式正确

🔍 测试5: Word导出功能
✅ Word生成API正常
✅ 返回Word格式正确

🔍 测试6: 缓存状态API
✅ 缓存状态API正常

📊 测试结果汇总
==================================================
✅ 通过 健康检查
✅ 通过 方案生成
✅ 通过 关键词拓展
✅ 通过 PDF导出
✅ 通过 Word导出
✅ 通过 缓存状态

🎯 总体结果: 6/6 测试通过
🎉 所有核心功能测试通过！UI简化后功能完整性验证成功
```

#### 详细说明
参考：[核心功能测试文档](./CORE_FUNCTIONALITY_TESTING.md)

### 5. 内容保护功能测试页面 (`/copy-test`)

提供可视化界面测试内容保护功能。

#### 访问方法
```
http://localhost:3000/copy-test
```

#### 测试功能
- 复制功能测试（文本、图片）
- 键盘快捷键拦截测试
- 右键菜单禁用测试
- 配置管理器测试
- 保护状态实时切换

#### 详细说明
参考：[内容保护测试指南](./protection-test-guide.md)

## 开发工作流程

### 1. 功能开发后的测试流程

```bash
# 1. 验证AI模型可用性
node scripts/verify-models.js

# 2. 测试PDF转换功能
node scripts/test-pdf-conversion.js

# 3. 测试Markdown解析功能
pnpm test

# 4. 启动开发服务器
pnpm dev

# 5. 访问测试页面验证功能
# http://localhost:3000/copy-test
```

### 2. 新功能测试

当添加新的Markdown格式支持时：

1. 在`temp/test-export.js`中添加测试用例
2. 运行测试脚本验证解析结果
3. 在实际页面中测试渲染效果
4. 验证Word导出功能是否正确处理新格式

### 3. 回归测试

在重要更新后，运行所有测试工具：

```bash
# 完整测试流程
node scripts/verify-models.js
node scripts/test-pdf-conversion.js
pnpm test
pnpm dev
# 手动测试各个功能页面
```

## 测试用例扩展

### 添加新的Markdown测试用例

在`temp/test-export.js`中扩展测试内容：

```javascript
const testMarkdown = `
# 现有测试内容...

## 新增测试格式

### 嵌套列表测试
- 一级列表
  - 二级列表
    - 三级列表

### 链接测试
[链接文本](https://example.com)

### 图片测试
![图片描述](https://example.com/image.jpg)
`;
```

### 自定义测试脚本

可以创建专门的测试脚本来验证特定功能：

```javascript
// 创建 temp/test-specific-feature.js
function testSpecificFeature() {
  // 测试特定功能的逻辑
  console.log('测试特定功能...');
}

testSpecificFeature();
```

## 故障排除

### 常见问题

1. **模型验证失败**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 验证模型ID是否正确

2. **PDF转换测试失败**
   - 检查LibreOffice是否正确安装
   - 确认PDF服务是否正常运行
   - 验证临时目录权限设置
   - 检查系统内存是否充足

3. **Markdown解析测试异常**
   - 检查Node.js版本是否符合要求
   - 确认测试脚本语法正确
   - 验证解析器实现是否有更新

4. **测试页面无法访问**
   - 确认开发服务器已启动
   - 检查端口是否被占用
   - 验证路由配置是否正确

### 调试技巧

1. **详细日志输出**
   ```javascript
   console.log('详细的调试信息:', debugData);
   ```

2. **分步测试**
   ```javascript
   // 分步验证每个功能点
   console.log('步骤1: 解析标题');
   // 测试标题解析
   console.log('步骤2: 解析段落');
   // 测试段落解析
   ```

3. **错误捕获**
   ```javascript
   try {
     // 测试代码
   } catch (error) {
     console.error('测试失败:', error.message);
   }
   ```

## 最佳实践

### 1. 测试驱动开发

- 先编写测试用例，再实现功能
- 确保所有新功能都有对应的测试
- 定期运行测试确保功能稳定

### 2. 持续集成

- 在代码提交前运行所有测试
- 自动化测试流程
- 及时修复测试失败的问题

### 3. 文档同步

- 测试用例变更时同步更新文档
- 保持测试说明的准确性
- 提供清晰的测试指引

## 总结

完善的测试工具体系确保了项目的稳定性和可靠性：

- **AI模型验证**: 确保所有模型正常可用
- **PDF转换测试**: 验证PDF生成功能的完整性和性能
- **Markdown解析测试**: 验证内容解析的准确性
- **功能测试页面**: 提供可视化的功能验证
- **开发友好**: 提供清晰的测试输出和调试信息

通过这些测试工具，开发者可以快速验证功能正确性，及时发现和修复问题，确保项目的高质量交付。