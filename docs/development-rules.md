# 开发规则和约定

## 📋 核心开发规则

### 1. 代码模块化原则
- **规则**: 代码尽可能模块化，避免单个文件过大
- **执行标准**: 
  - 单个文件不超过 500 行代码
  - 功能相关的代码组织在同一模块
  - 使用清晰的文件夹结构分类

### 2. 临时文件管理规则
- **规则**: `temp/` 目录下的内容是临时文件
- **注意事项**: 
  - 这些文件可能随时删除，不会提前通知
  - 需要将有用内容及时迁移到合适位置
  - 不要在临时目录中存放重要文件

### 3. 测试文件隔离规则
- **规则**: 所有测试文件都要在单独的目录下
- **目录结构**:
  ```
  tests/
  ├── unit/           # 单元测试
  ├── integration/    # 集成测试
  ├── fixtures/       # 测试数据
  ├── scripts/        # 测试脚本
  ├── config/         # 测试配置
  └── temp/           # 临时测试文件
  ```

### 4. 上线清理规则
- **规则**: 上线前要手动清理测试文件
- **执行命令**: `pnpm run cleanup`
- **重要变更**: 自动清理的prebuild钩子已移除，需要手动执行清理

### 5. 规则遵循原则
- **规则**: 严格按照约定的规则执行开发
- **记录要求**: 所有规则变更都要有文档记录
- **执行监督**: 定期检查规则执行情况

### 6. 🚨 **客户端依赖管理规则**（新增）
- **规则**: 严禁在客户端组件中直接导入大型库
- **大型库定义**: 文件大小 > 1MB 的库（如 docx、jspdf、file-saver、puppeteer 等）
- **执行标准**:
  - 大型库只能在服务端 API 路由中使用
  - 客户端通过 API 调用获取功能
  - 使用 `serverExternalPackages` 配置排除客户端打包
- **检查方法**: 
  ```bash
  # 检查构建包大小
  pnpm build
  # 查看构建输出，确保单个文件 < 25MB
  ```

### 7. 🔧 **构建优化规则**（新增）
- **规则**: 所有构建配置必须考虑部署平台限制
- **执行标准**:
  - 单个文件大小 < 25MB（EdgeOne 限制）
  - 使用 Webpack 分包策略
  - 配置外部依赖排除
- **配置要求**:
  ```javascript
  // next.config.mjs 必须包含
  serverExternalPackages: ['大型库列表']
  webpack: { splitChunks: { maxSize: 20000000 } }
  ```

### 8. 📦 **部署前验证规则**（新增）
- **规则**: 每次部署前必须验证构建产物
- **验证清单**:
  - [ ] 运行 `pnpm build` 无错误
  - [ ] 检查构建输出文件大小
  - [ ] 验证 API 路由功能正常
  - [ ] 确认环境变量配置完整
- **部署参数记录**: 见部署配置规则

## 🎯 执行检查清单

### 开发前检查
- [ ] 确认临时文件已迁移
- [ ] 检查代码模块化程度
- [ ] 验证测试文件位置

### 开发中检查
- [ ] 新增文件符合模块化要求
- [ ] 测试文件放在正确目录
- [ ] 避免在临时目录存放重要文件

### 上线前检查
- [ ] **手动运行** `pnpm run cleanup` 清理测试文件
- [ ] 确认所有临时文件已处理
- [ ] 验证项目结构清洁

## 🔧 相关工具和命令

### 清理命令
```bash
# 手动清理测试文件（必须手动执行）
pnpm run cleanup

# 构建项目（不再自动清理）
pnpm build

# 运行测试
pnpm test
```

### 目录检查
```bash
# 检查项目结构
ls -la

# 检查测试目录
ls -la tests/

# 检查临时目录
ls -la temp/
```

## 📝 规则更新记录

- **2025-01-20**: 新增客户端依赖管理、构建优化、部署前验证规则
- **2025-01-20**: 基于 EdgeOne 部署问题的经验总结
- **2025-01-19**: 移除prebuild自动清理钩子，改为手动清理模式
- **2025-01-19**: 初始规则制定
- **规则来源**: 用户约定的5条开发规则 + 实际部署经验
- **适用范围**: 整个项目开发周期

## 🚀 **部署配置规则**（新增）

### 部署环境要求
- **Node.js**: >= 18.0.0
- **包管理器**: pnpm >= 8.0.0
- **内存要求**: >= 2GB（用于文档生成）

### 环境变量配置
```bash
# 必需的环境变量
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://your-domain.com

# API 相关配置
API_TIMEOUT=30000
MAX_FILE_SIZE=10485760  # 10MB

# 可选配置
ENABLE_ANALYTICS=true
LOG_LEVEL=info
```

### 部署平台特定配置

#### 腾讯云 EdgeOne
- **文件大小限制**: 25MiB
- **必需配置**: Webpack 分包
- **构建命令**: `pnpm build`
- **启动命令**: `pnpm start`

#### Vercel
- **函数超时**: 10s (Hobby) / 60s (Pro)
- **内存限制**: 1GB (Hobby) / 3GB (Pro)
- **构建配置**: 自动检测 Next.js

#### Netlify
- **函数超时**: 10s (Free) / 26s (Pro)
- **构建命令**: `pnpm build`
- **发布目录**: `.next`

### 部署前检查清单
- [ ] 运行 `pnpm run cleanup` 清理测试文件
- [ ] 运行 `pnpm build` 验证构建成功
- [ ] 检查构建输出文件大小 < 25MB
- [ ] 验证环境变量配置完整
- [ ] 测试 API 路由功能正常
- [ ] 确认依赖包版本兼容
- [ ] 检查 Node.js 版本要求

### 常见部署问题及解决方案

#### 1. 构建文件过大
- **问题**: 单文件超过平台限制
- **解决**: 检查 `serverExternalPackages` 配置
- **验证**: `pnpm build` 查看文件大小

#### 2. API 超时
- **问题**: 文档生成超时
- **解决**: 增加超时配置或优化算法
- **验证**: 本地测试 API 响应时间

#### 3. 内存不足
- **问题**: 构建或运行时内存溢出
- **解决**: 升级部署套餐或优化代码
- **验证**: 监控内存使用情况

### 部署成功验证
```bash
# 验证部署是否成功
curl -I https://your-domain.com
curl -X POST https://your-domain.com/api/generate-word \
  -H "Content-Type: application/json" \
  -d '{"content":"test","storeName":"test"}'
```

## ⚠️ 重要变更说明

### prebuild钩子移除
- **变更**: 移除了package.json中的`"prebuild": "pnpm run cleanup"`钩子
- **影响**: 构建时不再自动清理测试文件
- **新流程**: 开发者需要在构建前手动运行`pnpm run cleanup`
- **原因**: 简化构建流程，给开发者更多控制权

### 新的构建流程
```bash
# 推荐的构建流程
pnpm run cleanup  # 手动清理测试文件
pnpm build        # 构建项目
pnpm start        # 启动生产服务器
```